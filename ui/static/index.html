<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TF-AI ‚Äî Terraform Expert Agent</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:        #0f1117;
      --surface:   #1a1d27;
      --border:    #2a2d3a;
      --accent:    #7c3aed;
      --accent-lt: #a78bfa;
      --text:      #e2e8f0;
      --text-muted:#94a3b8;
      --code-bg:   #0d1117;
      --user-bg:   #1e293b;
      --ai-bg:     #1a1d27;
      --success:   #10b981;
      --warning:   #f59e0b;
      --error:     #ef4444;
    }

    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
    header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 20px;
      border-bottom: 1px solid var(--border);
      background: var(--surface);
      flex-shrink: 0;
    }
    header .logo {
      width: 32px; height: 32px;
      background: var(--accent);
      border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
      font-weight: 700; font-size: 14px; color: #fff;
    }
    header h1 { font-size: 16px; font-weight: 600; }
    header .subtitle { font-size: 12px; color: var(--text-muted); margin-left: 4px; }
    header .provider-badge {
      margin-left: auto;
      font-size: 11px;
      padding: 3px 10px;
      border-radius: 20px;
      background: var(--border);
      color: var(--text-muted);
    }

    /* ‚îÄ‚îÄ Layout ‚îÄ‚îÄ */
    .layout {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ */
    .sidebar {
      width: 260px;
      border-right: 1px solid var(--border);
      background: var(--surface);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      overflow: hidden;
    }
    .sidebar-header {
      padding: 12px 16px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      border-bottom: 1px solid var(--border);
    }
    .workspace-input {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
    }
    .workspace-input input {
      flex: 1;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 6px 10px;
      font-size: 12px;
      color: var(--text);
      outline: none;
    }
    .workspace-input input:focus { border-color: var(--accent); }
    .workspace-input button {
      background: var(--accent);
      border: none;
      border-radius: 6px;
      padding: 6px 10px;
      color: #fff;
      font-size: 12px;
      cursor: pointer;
    }
    .file-tree {
      flex: 1;
      overflow-y: auto;
      padding: 8px 0;
    }
    .file-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 5px 16px;
      font-size: 13px;
      cursor: pointer;
      color: var(--text-muted);
      border-radius: 4px;
      margin: 0 4px;
    }
    .file-item:hover { background: var(--border); color: var(--text); }
    .file-item .icon { font-size: 14px; }
    .file-item.dir { color: var(--accent-lt); }
    .sidebar-actions {
      padding: 12px;
      border-top: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .sidebar-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-muted);
      font-size: 12px;
      cursor: pointer;
      text-align: left;
    }
    .sidebar-btn:hover { border-color: var(--accent); color: var(--text); }

    /* ‚îÄ‚îÄ Chat panel ‚îÄ‚îÄ */
    .chat-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .message {
      display: flex;
      gap: 12px;
      max-width: 860px;
      width: 100%;
      align-self: flex-start;
    }
    .message.user { align-self: flex-end; flex-direction: row-reverse; }
    .avatar {
      width: 32px; height: 32px;
      border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
      font-size: 14px;
      flex-shrink: 0;
    }
    .message.user .avatar { background: var(--accent); }
    .message.ai .avatar   { background: #1e3a5f; }
    .bubble {
      padding: 12px 16px;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.6;
      max-width: 780px;
    }
    .message.user .bubble {
      background: var(--user-bg);
      border: 1px solid var(--border);
      border-top-right-radius: 2px;
    }
    .message.ai .bubble {
      background: var(--ai-bg);
      border: 1px solid var(--border);
      border-top-left-radius: 2px;
    }
    .bubble pre {
      background: var(--code-bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      overflow-x: auto;
      margin: 8px 0;
      font-size: 13px;
      font-family: 'JetBrains Mono', 'Fira Code', monospace;
    }
    .bubble code { font-family: 'JetBrains Mono', 'Fira Code', monospace; font-size: 13px; }
    .bubble p { margin: 6px 0; }
    .bubble ul, .bubble ol { padding-left: 20px; margin: 6px 0; }

    .typing-indicator {
      display: flex;
      gap: 4px;
      padding: 8px 0;
      align-items: center;
    }
    .typing-indicator span {
      width: 6px; height: 6px;
      background: var(--accent-lt);
      border-radius: 50%;
      animation: bounce 1.2s infinite;
    }
    .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
    .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes bounce {
      0%, 60%, 100% { transform: translateY(0); }
      30%            { transform: translateY(-6px); }
    }

    /* ‚îÄ‚îÄ Input bar ‚îÄ‚îÄ */
    .input-bar {
      padding: 16px 20px;
      border-top: 1px solid var(--border);
      background: var(--surface);
      flex-shrink: 0;
    }
    .input-row {
      display: flex;
      gap: 10px;
      align-items: flex-end;
    }
    .input-row textarea {
      flex: 1;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px 14px;
      font-size: 14px;
      color: var(--text);
      resize: none;
      outline: none;
      min-height: 48px;
      max-height: 180px;
      font-family: inherit;
      line-height: 1.5;
    }
    .input-row textarea:focus { border-color: var(--accent); }
    .input-row textarea::placeholder { color: var(--text-muted); }
    .send-btn {
      width: 44px; height: 44px;
      background: var(--accent);
      border: none;
      border-radius: 10px;
      color: #fff;
      font-size: 18px;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0;
      transition: background 0.15s;
    }
    .send-btn:hover { background: #6d28d9; }
    .send-btn:disabled { background: var(--border); cursor: not-allowed; }
    .input-hints {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      flex-wrap: wrap;
    }
    .hint-chip {
      padding: 4px 10px;
      background: var(--border);
      border-radius: 20px;
      font-size: 11px;
      color: var(--text-muted);
      cursor: pointer;
      border: none;
    }
    .hint-chip:hover { background: var(--accent); color: #fff; }

    /* ‚îÄ‚îÄ Welcome ‚îÄ‚îÄ */
    .welcome {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 16px;
      padding: 40px;
      text-align: center;
    }
    .welcome .big-logo {
      width: 64px; height: 64px;
      background: var(--accent);
      border-radius: 16px;
      display: flex; align-items: center; justify-content: center;
      font-size: 28px;
    }
    .welcome h2 { font-size: 22px; font-weight: 600; }
    .welcome p  { color: var(--text-muted); font-size: 14px; max-width: 480px; line-height: 1.6; }
    .welcome-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
      max-width: 600px;
      margin-top: 8px;
    }
    .welcome-chip {
      padding: 8px 14px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 13px;
      cursor: pointer;
      color: var(--text-muted);
      text-align: left;
    }
    .welcome-chip:hover { border-color: var(--accent); color: var(--text); }

    /* ‚îÄ‚îÄ Editor panel ‚îÄ‚îÄ */
    .editor-panel {
      width: 0;
      min-width: 0;
      border-left: 1px solid var(--border);
      background: var(--surface);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transition: width 0.2s ease;
      flex-shrink: 0;
    }
    .editor-panel.open {
      width: 420px;
      min-width: 320px;
    }
    .editor-header {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      font-size: 12px;
      flex-shrink: 0;
    }
    .editor-filename {
      flex: 1;
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      color: var(--text-muted);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .editor-filename.modified { color: var(--warning); }
    .editor-btn {
      padding: 4px 10px;
      border-radius: 5px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text-muted);
      font-size: 11px;
      cursor: pointer;
    }
    .editor-btn:hover { border-color: var(--accent); color: var(--text); }
    .editor-btn.save { background: var(--accent); border-color: var(--accent); color: #fff; }
    .editor-btn.save:hover { background: #6d28d9; }
    .editor-btn.close { font-size: 14px; padding: 2px 7px; }
    .editor-textarea {
      flex: 1;
      background: var(--code-bg);
      color: var(--text);
      border: none;
      outline: none;
      padding: 14px;
      font-family: 'JetBrains Mono', 'Fira Code', monospace;
      font-size: 12px;
      line-height: 1.6;
      resize: none;
      tab-size: 2;
    }
    .editor-status {
      padding: 4px 12px;
      font-size: 10px;
      color: var(--text-muted);
      border-top: 1px solid var(--border);
      flex-shrink: 0;
      min-height: 22px;
    }
    .file-item { cursor: pointer; }
    .file-item.active { background: var(--border); color: var(--text); }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

    /* ‚îÄ‚îÄ Auth modal ‚îÄ‚îÄ */
    .modal-overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.7);
      display: flex; align-items: center; justify-content: center;
      z-index: 1000;
    }
    .modal-overlay.hidden { display: none; }
    .modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 28px 32px;
      width: 380px;
      display: flex; flex-direction: column; gap: 16px;
    }
    .modal h2 { font-size: 16px; font-weight: 600; }
    .modal p  { font-size: 13px; color: var(--text-muted); line-height: 1.5; }
    .modal input {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 10px 12px;
      font-size: 13px;
      color: var(--text);
      outline: none;
      width: 100%;
      font-family: 'JetBrains Mono', monospace;
    }
    .modal input:focus { border-color: var(--accent); }
    .modal-error { font-size: 12px; color: var(--error); min-height: 16px; }
    .modal-btn {
      padding: 10px;
      background: var(--accent);
      border: none; border-radius: 6px;
      color: #fff; font-size: 14px; font-weight: 500;
      cursor: pointer;
    }
    .modal-btn:hover { background: #6d28d9; }
  </style>
</head>
<body>

<!-- Auth modal ‚Äî shown when TFAI_API_KEY is set server-side -->
<div class="modal-overlay hidden" id="authModal">
  <div class="modal">
    <h2>üîê API Key Required</h2>
    <p>This TF-AI server requires an API key. Enter the value of <code style="font-family:monospace;color:var(--accent-lt)">TFAI_API_KEY</code> set on the server.</p>
    <input type="password" id="apiKeyInput" placeholder="Enter API key‚Ä¶" onkeydown="handleAuthKey(event)" />
    <div class="modal-error" id="authError"></div>
    <button class="modal-btn" onclick="submitApiKey()">Connect</button>
  </div>
</div>

<header>
  <div class="logo">TF</div>
  <h1>TF-AI</h1>
  <span class="subtitle">Terraform Expert Agent</span>
  <span class="provider-badge" id="providerBadge">‚óè ollama</span>
</header>

<div class="layout">
  <!-- Sidebar: workspace file tree -->
  <aside class="sidebar">
    <div class="sidebar-header">Workspace</div>
    <div class="workspace-input">
      <input type="text" id="workspaceDir" placeholder="/path/to/terraform/project" />
      <button onclick="loadWorkspace()">‚Üí</button>
    </div>
    <div class="file-tree" id="fileTree">
      <div style="padding: 16px; font-size: 12px; color: var(--text-muted); text-align: center;">
        Enter a workspace path above to browse files
      </div>
    </div>
    <div class="sidebar-actions">
      <button class="sidebar-btn" onclick="insertPrompt('Run terraform plan in my workspace and explain the changes')">
        üìã Analyse Plan
      </button>
      <button class="sidebar-btn" onclick="insertPrompt('Review my terraform code for security issues and best practices')">
        üîí Security Review
      </button>
      <button class="sidebar-btn" onclick="insertPrompt('Show me the current state of all managed resources')">
        üìä Inspect State
      </button>
    </div>
  </aside>

  <!-- Chat panel -->
  <main class="chat-panel">
    <div class="messages" id="messages">
      <div class="welcome" id="welcome">
        <div class="big-logo">üèóÔ∏è</div>
        <h2>TF-AI Terraform Expert</h2>
        <p>Your AI-powered Terraform engineer. Generate infrastructure code, diagnose failures, and get expert guidance across AWS, Azure, and GCP.</p>
        <div class="welcome-chips">
          <button class="welcome-chip" onclick="insertPrompt('Generate an EKS cluster with IRSA, private endpoints, and managed node groups')">
            ‚òÅÔ∏è EKS cluster with IRSA
          </button>
          <button class="welcome-chip" onclick="insertPrompt('Generate an AKS cluster with Azure CNI and workload identity on Azure')">
            ‚òÅÔ∏è AKS with workload identity
          </button>
          <button class="welcome-chip" onclick="insertPrompt('Generate a GKE cluster with Workload Identity and private nodes on GCP')">
            ‚òÅÔ∏è GKE with Workload Identity
          </button>
          <button class="welcome-chip" onclick="insertPrompt('Why did my terraform apply fail? How do I diagnose it?')">
            üîç Diagnose apply failure
          </button>
          <button class="welcome-chip" onclick="insertPrompt('How do I recover from a corrupted or locked terraform state file?')">
            üõ†Ô∏è Fix corrupted state
          </button>
          <button class="welcome-chip" onclick="insertPrompt('What is the best way to structure a multi-account AWS Terraform setup?')">
            üèõÔ∏è Multi-account AWS structure
          </button>
        </div>
      </div>
    </div>

    <div class="input-bar">
      <div class="input-row">
        <textarea
          id="userInput"
          placeholder="Ask anything about Terraform ‚Äî generate code, diagnose failures, review state..."
          rows="1"
          onkeydown="handleKey(event)"
          oninput="autoResize(this)"
        ></textarea>
        <button class="send-btn" id="sendBtn" onclick="sendMessage()">‚Üë</button>
      </div>
      <div class="input-hints">
        <button class="hint-chip" onclick="insertPrompt('Generate a secure S3 bucket with versioning and encryption')">S3 bucket</button>
        <button class="hint-chip" onclick="insertPrompt('Create a VPC with public and private subnets across 3 AZs')">VPC layout</button>
        <button class="hint-chip" onclick="insertPrompt('Generate IAM roles with least-privilege policies for EKS node groups')">IAM roles</button>
        <button class="hint-chip" onclick="insertPrompt('How do I use terraform workspaces for environment separation?')">Workspaces</button>
        <button class="hint-chip" onclick="insertPrompt('Generate a Terraform module structure for a reusable EKS cluster')">Module structure</button>
      </div>
    </div>
  </main>

  <!-- File editor panel ‚Äî opens when a file is clicked in the sidebar -->
  <aside class="editor-panel" id="editorPanel">
    <div class="editor-header">
      <span class="editor-filename" id="editorFilename">No file open</span>
      <button class="editor-btn" onclick="insertPromptFromEditor()">üí¨ Discuss</button>
      <button class="editor-btn save" id="editorSaveBtn" onclick="saveFile()">Save</button>
      <button class="editor-btn close" onclick="closeEditor()" title="Close editor">‚úï</button>
    </div>
    <textarea
      class="editor-textarea"
      id="editorTextarea"
      spellcheck="false"
      oninput="onEditorChange()"
      onkeydown="handleEditorKey(event)"
    ></textarea>
    <div class="editor-status" id="editorStatus"></div>
  </aside>
</div>

<script>
  let isStreaming = false;

  // ‚îÄ‚îÄ Auth ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // API key stored in sessionStorage ‚Äî cleared when the tab closes.
  // Never stored in source, cookies, or localStorage.
  let apiKey = sessionStorage.getItem('tfai_api_key') || '';

  // apiFetch wraps fetch() and injects Authorization: Bearer when a key is set.
  // All /api/* calls (except /api/health, /api/ready, /api/config) must use this.
  function apiFetch(url, opts = {}) {
    if (apiKey) {
      opts.headers = Object.assign({}, opts.headers || {}, {
        'Authorization': 'Bearer ' + apiKey,
      });
    }
    return fetch(url, opts);
  }

  function handleAuthKey(e) {
    if (e.key === 'Enter') submitApiKey();
  }

  async function submitApiKey() {
    const input = document.getElementById('apiKeyInput');
    const key = input.value.trim();
    if (!key) {
      document.getElementById('authError').textContent = 'Key must not be empty.';
      return;
    }
    // Probe a protected endpoint to validate the key before accepting it.
    const resp = await fetch('/api/workspace?dir=/', {
      headers: { 'Authorization': 'Bearer ' + key },
    });
    if (resp.status === 401) {
      document.getElementById('authError').textContent = 'Invalid key ‚Äî please try again.';
      input.value = '';
      input.focus();
      return;
    }
    apiKey = key;
    sessionStorage.setItem('tfai_api_key', key);
    document.getElementById('authModal').classList.add('hidden');
    document.getElementById('authError').textContent = '';
  }

  function showAuthModal() {
    document.getElementById('authModal').classList.remove('hidden');
    setTimeout(() => document.getElementById('apiKeyInput').focus(), 50);
  }

  function autoResize(el) {
    el.style.height = 'auto';
    el.style.height = Math.min(el.scrollHeight, 180) + 'px';
  }

  function handleKey(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  }

  function insertPrompt(text) {
    const input = document.getElementById('userInput');
    input.value = text;
    autoResize(input);
    input.focus();
  }

  function hideWelcome() {
    const welcome = document.getElementById('welcome');
    if (welcome) welcome.remove();
  }

  function appendMessage(role, content) {
    hideWelcome();
    const messages = document.getElementById('messages');
    const div = document.createElement('div');
    div.className = `message ${role}`;
    div.innerHTML = `
      <div class="avatar">${role === 'user' ? 'üë§' : 'ü§ñ'}</div>
      <div class="bubble" id="bubble-${Date.now()}">${escapeHtml(content)}</div>
    `;
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
    return div.querySelector('.bubble');
  }

  function appendStreamingMessage() {
    hideWelcome();
    const messages = document.getElementById('messages');
    const div = document.createElement('div');
    div.className = 'message ai';
    const id = 'stream-' + Date.now();
    div.innerHTML = `
      <div class="avatar">ü§ñ</div>
      <div class="bubble" id="${id}">
        <div class="typing-indicator"><span></span><span></span><span></span></div>
      </div>
    `;
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
    return document.getElementById(id);
  }

  function escapeHtml(text) {
    return text
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;');
  }

  function renderMarkdown(text) {
    // Fenced code blocks first (before other replacements mangle them)
    text = text.replace(/```[\w]*\n?([\s\S]*?)```/g, (_, code) =>
      `<pre><code>${escapeHtml(code.trimEnd())}</code></pre>`);
    // Process line by line for block elements
    const lines = text.split('\n');
    const out = [];
    let inList = false;
    for (let i = 0; i < lines.length; i++) {
      let line = lines[i];
      // Skip lines already replaced by code block
      if (line.startsWith('<pre>')) { if (inList) { out.push('</ul>'); inList = false; } out.push(line); continue; }
      // Headings
      if (/^### (.+)/.test(line)) { if (inList) { out.push('</ul>'); inList = false; } out.push(`<h4 style="margin:10px 0 4px;font-size:13px;color:var(--accent-lt)">${line.slice(4)}</h4>`); continue; }
      if (/^## (.+)/.test(line))  { if (inList) { out.push('</ul>'); inList = false; } out.push(`<h3 style="margin:12px 0 4px;font-size:14px;color:var(--accent-lt)">${line.slice(3)}</h3>`); continue; }
      if (/^# (.+)/.test(line))   { if (inList) { out.push('</ul>'); inList = false; } out.push(`<h2 style="margin:14px 0 6px;font-size:15px;color:var(--accent-lt)">${line.slice(2)}</h2>`); continue; }
      // Horizontal rule
      if (/^---+$/.test(line.trim())) { if (inList) { out.push('</ul>'); inList = false; } out.push('<hr style="border:none;border-top:1px solid var(--border);margin:10px 0">'); continue; }
      // Bullet list items
      if (/^[\-\*] (.+)/.test(line)) {
        if (!inList) { out.push('<ul style="padding-left:18px;margin:6px 0">'); inList = true; }
        const item = line.replace(/^[\-\*] /, '');
        out.push(`<li>${inlineMarkdown(item)}</li>`);
        continue;
      }
      // Numbered list
      if (/^\d+\. (.+)/.test(line)) {
        if (!inList) { out.push('<ol style="padding-left:18px;margin:6px 0">'); inList = true; }
        const item = line.replace(/^\d+\. /, '');
        out.push(`<li>${inlineMarkdown(item)}</li>`);
        continue;
      }
      // Close list on blank line or non-list content
      if (inList) { out.push('</ul>'); inList = false; }
      // Blank line ‚Üí paragraph break
      if (line.trim() === '') { out.push('<br>'); continue; }
      out.push(`<p style="margin:4px 0">${inlineMarkdown(line)}</p>`);
    }
    if (inList) out.push('</ul>');
    return out.join('');
  }

  function inlineMarkdown(text) {
    return text
      .replace(/`([^`]+)`/g, '<code>$1</code>')
      .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
      .replace(/\*([^*]+)\*/g, '<em>$1</em>');
  }

  async function sendMessage() {
    if (isStreaming) return;
    const input = document.getElementById('userInput');
    const message = input.value.trim();
    if (!message) return;

    input.value = '';
    autoResize(input);
    document.getElementById('sendBtn').disabled = true;
    isStreaming = true;

    appendMessage('user', message);
    const bubble = appendStreamingMessage();

    try {
      const response = await apiFetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message, workspaceDir: document.getElementById('workspaceDir').value.trim() }),
      });

      if (!response.ok) {
        bubble.innerHTML = `<span style="color:var(--error)">Error: ${response.statusText}</span>`;
        return;
      }

      const reader = response.body.getReader();
      const decoder = new TextDecoder();
      let fullText = '';
      let currentEvent = '';
      bubble.innerHTML = '';

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;

        const chunk = decoder.decode(value, { stream: true });
        const lines = chunk.split('\n');

        for (const line of lines) {
          if (line.startsWith('event: ')) {
            currentEvent = line.slice(7).trim();
          } else if (line.startsWith('data: ')) {
            const data = line.slice(6);
            if (data === '[DONE]') break;
            if (currentEvent === 'files_written') {
              loadWorkspace();
              currentEvent = '';
            } else {
              fullText += data + '\n';
              bubble.innerHTML = renderMarkdown(fullText);
              document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
            }
          } else if (line === '') {
            currentEvent = '';
          }
        }
      }
    } catch (err) {
      bubble.innerHTML = `<span style="color:var(--error)">Connection error: ${err.message}</span>`;
    } finally {
      isStreaming = false;
      document.getElementById('sendBtn').disabled = false;
      document.getElementById('userInput').focus();
    }
  }

  async function loadWorkspace() {
    const dir = document.getElementById('workspaceDir').value.trim();
    if (!dir) return;
    const tree = document.getElementById('fileTree');
    tree.innerHTML = '<div style="padding:16px;font-size:12px;color:var(--text-muted)">Loading...</div>';

    try {
      const resp = await apiFetch('/api/workspace?dir=' + encodeURIComponent(dir));
      if (!resp.ok) {
        const err = await resp.json().catch(() => ({ error: resp.statusText }));
        tree.innerHTML = `<div style="padding:16px;font-size:12px;color:var(--error)">${err.error || 'Failed to load workspace'}</div>`;
        return;
      }
      const data = await resp.json();

      const badges = [];
      if (data.initialized) badges.push('<span style="color:var(--success);font-size:10px">‚úì init</span>');
      if (data.hasState)     badges.push('<span style="color:var(--warning);font-size:10px">‚¨° state</span>');
      if (data.hasLockfile)  badges.push('<span style="color:var(--accent-lt);font-size:10px">üîí lock</span>');

      const dirName = dir.split('/').pop() || dir;
      let html = `<div class="file-item dir"><span class="icon">üìÅ</span>${dirName} ${badges.join(' ')}</div>`;

      // Group files by their parent directory (relative to workspace root)
      if (data.files && data.files.length > 0) {
        const groups = {};
        for (const rel of data.files) {
          const parts = rel.split('/');
          const dirKey = parts.length > 1 ? parts.slice(0, -1).join('/') : '';
          if (!groups[dirKey]) groups[dirKey] = [];
          groups[dirKey].push({ rel, name: parts[parts.length - 1] });
        }
        // Root files first, then subdirs sorted
        const keys = Object.keys(groups).sort((a, b) => {
          if (a === '') return -1;
          if (b === '') return 1;
          return a.localeCompare(b);
        });
        for (const key of keys) {
          if (key !== '') {
            html += `<div class="file-item dir" style="padding-left:20px"><span class="icon">üìÅ</span>${key}</div>`;
          }
          const indent = key === '' ? 28 : 36;
          for (const { rel, name } of groups[key]) {
            const fullPath = dir.replace(/\/+$/, '') + '/' + rel;
            html += `<div class="file-item" style="padding-left:${indent}px" onclick="openFile('${fullPath.replace(/'/g, "\\'")}', this)"><span class="icon">üìÑ</span>${name}</div>`;
          }
        }
      } else {
        // No files ‚Äî offer to scaffold
        html += '<div style="padding:8px 28px;font-size:11px;color:var(--text-muted)">No .tf files found</div>';
        html += `<div style="padding:4px 28px;font-size:11px;color:var(--text-muted)">Create the directory first, then scaffold starter files into it.</div>`;
        html += `<div style="padding:4px 28px"><button class="sidebar-btn" style="font-size:11px" onclick="createWorkspace('${dir.replace(/'/g, "\\'")}')">+ Scaffold starter files</button></div>`;
      }

      tree.innerHTML = html;
      insertPrompt(`I'm working in the Terraform workspace at ${dir}. `);
    } catch (err) {
      tree.innerHTML = `<div style="padding:16px;font-size:12px;color:var(--error)">Connection error: ${err.message}</div>`;
    }
  }

  async function createWorkspace(dir) {
    const description = prompt('Describe what this workspace is for (optional):');
    const tree = document.getElementById('fileTree');
    tree.innerHTML = '<div style="padding:16px;font-size:12px;color:var(--text-muted)">Creating workspace...</div>';

    try {
      const resp = await apiFetch('/api/workspace/create', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ dir, description: description || '' }),
      });
      const data = await resp.json();
      if (!resp.ok) {
        tree.innerHTML = `<div style="padding:16px;font-size:12px;color:var(--error)">${data.error || 'Failed to create workspace'}</div>`;
        return;
      }
      if (data.prompt) insertPrompt(data.prompt);
      await loadWorkspace();
    } catch (err) {
      tree.innerHTML = `<div style="padding:16px;font-size:12px;color:var(--error)">Connection error: ${err.message}</div>`;
    }
  }

  // ‚îÄ‚îÄ Editor ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let editorPath = null;
  let editorOriginal = '';
  let editorModified = false;

  async function openFile(path, el) {
    // Mark active item in sidebar
    document.querySelectorAll('.file-item').forEach(i => i.classList.remove('active'));
    if (el) el.classList.add('active');

    try {
      const wsDir = document.getElementById('workspaceDir').value.trim();
      const resp = await apiFetch('/api/file?path=' + encodeURIComponent(path) + '&workspaceDir=' + encodeURIComponent(wsDir));
      if (!resp.ok) {
        const err = await resp.json().catch(() => ({ error: resp.statusText }));
        setEditorStatus('Error: ' + (err.error || resp.statusText), true);
        return;
      }
      const data = await resp.json();
      editorPath = data.path;
      editorOriginal = data.content;
      editorModified = false;

      const ta = document.getElementById('editorTextarea');
      ta.value = data.content;

      const fname = document.getElementById('editorFilename');
      fname.textContent = path.split('/').pop();
      fname.classList.remove('modified');

      document.getElementById('editorPanel').classList.add('open');
      setEditorStatus('Opened ' + path.split('/').pop());
      ta.focus();
    } catch (err) {
      setEditorStatus('Connection error: ' + err.message, true);
    }
  }

  function onEditorChange() {
    if (!editorPath) return;
    const current = document.getElementById('editorTextarea').value;
    editorModified = current !== editorOriginal;
    const fname = document.getElementById('editorFilename');
    fname.classList.toggle('modified', editorModified);
    if (editorModified) {
      fname.textContent = document.getElementById('editorFilename').textContent.replace(' ‚Ä¢', '') + ' ‚Ä¢';
    }
    setEditorStatus(editorModified ? 'Unsaved changes' : '');
  }

  function handleEditorKey(e) {
    // Tab ‚Üí insert 2 spaces
    if (e.key === 'Tab') {
      e.preventDefault();
      const ta = document.getElementById('editorTextarea');
      const start = ta.selectionStart;
      const end = ta.selectionEnd;
      ta.value = ta.value.substring(0, start) + '  ' + ta.value.substring(end);
      ta.selectionStart = ta.selectionEnd = start + 2;
      onEditorChange();
    }
    // Ctrl/Cmd+S ‚Üí save
    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
      e.preventDefault();
      saveFile();
    }
  }

  async function saveFile() {
    if (!editorPath) return;
    const content = document.getElementById('editorTextarea').value;
    setEditorStatus('Saving...');
    try {
      const wsDir = document.getElementById('workspaceDir').value.trim();
      const resp = await apiFetch('/api/file', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ path: editorPath, workspaceDir: wsDir, content }),
      });
      if (!resp.ok) {
        const err = await resp.json().catch(() => ({ error: resp.statusText }));
        setEditorStatus('Save failed: ' + (err.error || resp.statusText), true);
        return;
      }
      editorOriginal = content;
      editorModified = false;
      const fname = document.getElementById('editorFilename');
      fname.textContent = editorPath.split('/').pop();
      fname.classList.remove('modified');
      setEditorStatus('Saved ‚úì');
      setTimeout(() => setEditorStatus(''), 2000);
    } catch (err) {
      setEditorStatus('Connection error: ' + err.message, true);
    }
  }

  function closeEditor() {
    if (editorModified) {
      if (!confirm('You have unsaved changes. Close anyway?')) return;
    }
    document.getElementById('editorPanel').classList.remove('open');
    document.querySelectorAll('.file-item').forEach(i => i.classList.remove('active'));
    editorPath = null;
    editorOriginal = '';
    editorModified = false;
  }

  function insertPromptFromEditor() {
    if (!editorPath) return;
    const fname = editorPath.split('/').pop();
    const content = document.getElementById('editorTextarea').value;
    insertPrompt(`Regarding the file ${fname}:\n\`\`\`hcl\n${content}\n\`\`\`\n\n`);
    document.getElementById('userInput').focus();
  }

  function setEditorStatus(msg, isError) {
    const el = document.getElementById('editorStatus');
    el.textContent = msg;
    el.style.color = isError ? 'var(--error)' : 'var(--text-muted)';
  }

  // Bootstrap: check /api/config to determine if auth is required,
  // then check /api/health to update the provider badge.
  (async function bootstrap() {
    try {
      const cfgResp = await fetch('/api/config');
      const cfg = await cfgResp.json();
      if (cfg.auth_required) {
        // If we already have a key in sessionStorage, validate it silently.
        if (apiKey) {
          const probe = await fetch('/api/workspace?dir=/', {
            headers: { 'Authorization': 'Bearer ' + apiKey },
          });
          if (probe.status === 401) {
            // Stored key is no longer valid ‚Äî clear it and prompt.
            apiKey = '';
            sessionStorage.removeItem('tfai_api_key');
            showAuthModal();
          }
        } else {
          showAuthModal();
        }
      }
    } catch (_) {
      // /api/config unreachable ‚Äî proceed unauthenticated, health check will show offline.
    }

    // Health check ‚Äî uses plain fetch since /api/health is unprotected.
    fetch('/api/health')
      .then(r => r.json())
      .then(() => {
        document.getElementById('providerBadge').style.color = 'var(--success)';
      })
      .catch(() => {
        document.getElementById('providerBadge').textContent = '‚óè offline';
        document.getElementById('providerBadge').style.color = 'var(--error)';
      });
  })();
</script>
</body>
</html>
